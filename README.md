# Test Buddy

An integration testing harness developed for my my own stuff. Use it, don't use it &mdash; either way, it's a bash.

![Test Buddy Logo](./assets/testbuddy.webp)

This library is two things:

- A set of bundlers, that take in your library and dependencies and produce a bundled output that can be run on an HTTP server
- A set of runners for interacting with those servers

## Install

```bash
npm install testbuddy
```

This library assumes the use of `vitest`, although maybe `jest` works too, I don't know.

## Usage

Test Buddy offers bundlers for the following strategies:

- `esbuild`
- `webpack`
- `UMD`
- `Node`

Test Buddy also offers the ability to test in the following environments:

- Clientside
  - via a browser, with Puppeteer
  - via a real browser, with Browserstack
- Serverside (Node.js)

### Bundling

Test Buddy offers the following four bundling strategies:

- `esbuild`
- `webpack`
- `UMD`
- `Node`

Bundling can be done in one of three ways:

- By calling `Test Buddy` from the command line, with `npm run Test Buddy bundle umd`
- By calling `Test Buddy` from a script, i.e., `"bundle_for_umd": "Test Buddy bundle umd"`
- By importing `Test Buddy` in your Javascript, with `import { bundle } from 'Test Buddy'`

We'll run through the four strategies and provide examples for command line and Javascript options (command line and script are identical options).

#### `esbuild`

Bundle via the command line with:

```bash
npm run Test Buddy bundle esbuild /path/to/output
```

or:

```javascript
import { bundle } from 'Test Buddy';

bundle('esbuild', '/path/to/output');
```

The bundler takes the following arguments, which can be provided either as command line flag arguments (`--arg`) or an arguments object as the third argument to `bundle`:

- `name` - the name for `package.json`
- `dependencies` - an array of dependencies and versions
- `devDependencies` - an array of devDependencies and versions

The dependencies will be installed, and also will be made available on the page under their package name.

The bundler comes with three EJS templates, which can be overriden:

```bash
npm run Test Buddy bundle esbuild /path/to/output --index.html ./index.html.ejs --index.js ./index.js.ejs --package.json ./package.json.ejs
```

or:

```javascript
import { bundle } from 'Test Buddy';

bundle('esbuild', '/path/to/output', {
  'index.html': './index.html.ejs',
  'index.js': './index.js.ejs',
  'index.json': './package.json.ejs',
});
```

You can see example templates in `./dist/bundlers/templates/esbuild`.

#### Webpack

Webpack is identical to `esbuild`. Same options and all.

#### UMD

### Testing

### Clientside, Puppeteer

To write a clientside test suite that leverages puppeteer:

```javascript
import { ClientsideTestRunner } from 'Test Buddy';
describe('Image Format Integration Tests', () => {
  const testRunner = new ClientsideTestRunner({
    mock: true,
    dist: '/path/to/your/bundled/code',
  });
  const page = (): Page => testRunner.page;

  beforeAll(async function beforeAll() {
    await testRunner.beforeAll();
  }, 60000);

  afterAll(async function imageAfterAll() {
    await testRunner.afterAll();
  }, 10000);

  beforeEach(async function beforeEach() {
    await testRunner.beforeEach('| Loaded');
  });

  afterEach(async function afterEach() {
    await testRunner.afterEach();
  });

  test('foo', () => {
    const result = await page().evaluate(() => {
      // do something in your page
    });
    expect(result).toEqual('foo');
  })
});
```

### Clientside, Browserstack

```javascript
describe('Browser tests', () => {
  const testRunner = new ClientsideTestRunner({
    name: 'browserstack',
    dist: '/path/to/dist/folder',
    useTunnel: true, // for browserstack, tunneling is required
  });

  test.each(browserOptions)("%j", async (capabilities: BrowserOption) => {
    driver = getDriver({ ...capabilities, build }, { verbose: VERBOSE });
    const ROOT_URL = await testRunner.getServerURL();;
    await driver.get(ROOT_URL);
    await driver.wait(async () => {
      const title = await driver.getTitle();
      return title.endsWith('| Loaded');
    }, 3000);

    const result = await executeAsyncScript(driver, () => {
      // run your page code here
    });
    await printLogs(driver, capabilities);
    expect(result).toEqual('foo');
  });
});
```

## License

[MIT](LICENSE)

## Acknowledgements

Logo generated by DALL-E (OpenAI). Thanks buddy!
